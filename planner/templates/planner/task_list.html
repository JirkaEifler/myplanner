{# Template: task_list.html
   Purpose: List view of all tasks.
   Displays tasks with list, tags, priority, due date, completion toggle, and action links. #}

{% extends "planner/base.html" %}
{% block nav_tasks %}is-active{% endblock %}
{% load static %}
{% load planner_extras %}
{% block title %}All My Tasks – MyPlanner{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'planner/css/tasks.css' %}?v=5">
{% endblock %}

{% block content %}
  <div class="table-wrap">
    <h1>All My Tasks</h1>

    <div class="toolbar">
      <a class="btn btn--primary" href="{% url 'html-task_create' %}">+ Create new task</a>
    </div>

    <table>
      <colgroup>
        <col class="col-list"    style="width:24%;">
        <col class="col-title"   style="width:26%;">
        <col class="col-tags"    style="width:16%;">
        <col class="col-prio"    style="width:6%;">
        <col class="col-date"    style="width:18%;">
        <col class="col-done"    style="width:10%;">
        <col class="col-actions" style="width:10%;">
      </colgroup>

      <thead>
        <tr>
          <th class="col-list">Open list detail</th>
          <th class="col-title">Open task detail</th>
          <th class="col-tags">Tags</th>
          <th class="col-prio">Priority</th>
          <th class="col-date">Due date</th>
          <th class="col-done">Done</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for t in tasks %}
          <tr>
            <!-- List -->
            <td class="col-list">
              <a class="chip"
                 style="--hue: {{ t.list.name|list_hue }};"
                 href="{% url 'html-list_detail' t.list.pk %}?from=tasks">
                {{ t.list.name }}
              </a>
            </td>

            <!-- Task title -->
            <td class="col-title">
              <div class="title-wrap">
                <a class="chip"
                   style="--hue: {{ t.list.name|list_hue }};"
                   href="{% url 'html-task_detail' t.pk %}">
                  {{ t.title }}
                </a>
              </div>
            </td>

            <!-- Task tags -->
            <td class="col-tags">
              <div class="tag-row">
                {% if t.tags.exists %}
                  {% for tag in t.tags.all %}
                    <span class="tag-chip"><span class="tag-hash">#</span>{{ tag.name }}</span>
                  {% empty %}
                    <span style="color:#9ca3af;">–</span>
                  {% endfor %}
                {% else %}
                  <span style="color:#9ca3af;">–</span>
                {% endif %}
              </div>
            </td>

            <!-- Priority -->
            <td class="col-prio">
              <span class="flag prio-{{ t.priority }}" title="{{ t.get_priority_display }}"></span>
            </td>

            <!-- Due date -->
            <td class="col-date">
              {{ t.due_date|date:"M. d, Y"|default:"—" }}
            </td>

            <!-- Done -->
            <td class="col-done done-cell">
              <input
                type="checkbox"
                class="js-done-toggle"
                data-id="{{ t.pk }}"
                {% if t.is_completed %}checked{% endif %}
              />
            </td>

            <!-- Actions -->
            <td class="col-actions">
              <div class="actions-wrap">
                <a class="btn-sm" href="{% url 'html-task_edit' t.pk %}">Edit</a>
                <a class="btn-sm btn-sm--warn" href="{% url 'html-task_delete' t.pk %}">Delete</a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="empty">No tasks found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ===== AJAX toggle Done ===== -->
  <script>
    // Get CSRF token from cookies
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // Attach toggle event listeners
    document.querySelectorAll('.js-done-toggle').forEach(cb => {
      cb.addEventListener('change', async (e) => {
        const el = e.currentTarget;
        const taskId = el.getAttribute('data-id');
        const url = "{% url 'html-task_toggle_done' 0 %}".replace('/0/', `/${taskId}/`);
        const previous = !el.checked;

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ done: el.checked })
          });

          if (!res.ok) throw new Error('Network error');
          const data = await res.json();
          if (!data.ok) {
            el.checked = previous;
            alert('Could not update task.');
          }
        } catch (err) {
          el.checked = previous;
          alert('Connection problem. Try again.');
        }
      });
    });
  </script>
{% endblock %}