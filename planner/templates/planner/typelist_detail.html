{# Template: typelist_detail.html
   Purpose: Detail view for a single to‑do list.
   Shows tasks in the list with tags, priority, due date, and inline “done” toggle. #}

{% extends "planner/base.html" %}
{% block nav_lists %}is-active{% endblock %}
{% load static %}
{% block title %}List detail – MyPlanner{% endblock %}
{% load planner_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'planner/css/list_detail.css' %}?v=8">
{% endblock %}

{% block content %}
  <h1>
    <span class="chip" style="--hue: {{ list.name|list_hue }};">{{ list.name }}</span>
  </h1>

  <div class="table-wrap">
    <div class="action-group" style="display:flex;gap:10px;justify-content:center;margin:10px 0 14px;">
      <a class="btn btn--primary" href="{% url 'html-task_create' %}?list={{ list.pk }}">+ Create task</a>

      {% if request.GET.from == 'tasks' %}
        <a class="btn btn-outline" href="{% url 'html-task_list' %}">Back</a>
      {% else %}
        <a class="btn btn-outline" href="{% url 'html-list_index' %}">Back</a>
      {% endif %}
    </div>
  </div>

  <table class="compact">
    <colgroup>
      <col class="col-title" style="width:44%;">
      <col class="col-tags"  style="width:20%;">
      <col class="col-prio"  style="width:12%;">
      <col class="col-date"  style="width:14%;">
      <col class="col-done"  style="width:10%;">
    </colgroup>
    <thead>
      <tr>
        <th class="col-title">Open task detail</th>
        <th class="col-tags">Tags</th>
        <th class="col-prio">Priority</th>
        <th class="col-date">Due date</th>
        <th class="col-done">Done</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tasks %}
        <tr>
          <!-- Open task detail -->
          <td class="col-title">
            <div class="title-wrap">
              <a class="chip"
                 style="--hue: {{ t.list.name|list_hue }};"
                 href="{% url 'html-task_detail' t.pk %}">
                {{ t.title }}
              </a>
            </div>
          </td>

          <!-- Tags -->
          <td class="col-tags">
            {% if t.tags.all %}
              <div class="tag-row">
                {% for tag in t.tags.all %}
                  <span class="tag-chip"><span class="tag-hash">#</span>{{ tag.name }}</span>
                {% endfor %}
              </div>
            {% else %}
              —
            {% endif %}
          </td>

          <!-- Priority -->
          <td class="col-prio">
            <span class="flag prio-{{ t.priority }}" title="{{ t.get_priority_display }}"></span>
          </td>

          <!-- Due date -->
          <td class="center">
            {{ t.due_date|date:"M. d, Y"|default:"—" }}
          </td>

          <!-- Done -->
          <td class="col-done done-cell">
            <input
              type="checkbox"
              class="js-done-toggle"
              data-id="{{ t.pk }}"
              {% if t.is_completed %}checked{% endif %}
            />
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="empty">No tasks found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    // AJAX: toggle task completion (checkbox) with CSRF protection
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('.js-done-toggle').forEach(cb => {
      cb.addEventListener('change', async (e) => {
        const el = e.currentTarget;
        const taskId = el.getAttribute('data-id');
        const url = "{% url 'html-task_toggle_done' 0 %}".replace('/0/', `/${taskId}/`);
        const previous = !el.checked;

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json',
            },
            body: new URLSearchParams({ done: el.checked ? '1' : '0' })
          });

          if (!res.ok) throw new Error('Network error');

          const data = await res.json();
          if (!data.ok) {
            el.checked = previous;
            alert('Could not update task. Try again.');
          }
        } catch (err) {
          el.checked = previous;
          alert('Connection problem. Try again.');
        }
      });
    });
  </script>
{% endblock %}